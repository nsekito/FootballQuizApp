# ポイントと経験値システムの実装計画

## 概要

現在のポイント（GP）システムを、exp（経験値）とポイントの2つの通貨に分離します。expでランクが上がり、ポイントを消費して昇格試験を受けることで新しい難易度をアンロックできるようにします。アンロックはカテゴリ+タグ単位で管理され、例えば柏レイソルのチームクイズNORMALはアンロック済みだが、マリノスのNORMALは未アンロックという状態が可能です。

## 実装内容

### 1. データモデルの拡張

#### 1.1 データベーススキーマの拡張
`lib/services/database_service.dart`の`user_data`テーブルに以下を追加：
- `total_exp`: 累計経験値（int）
- `total_points`: 累計ポイント（int、既存の`total_points`をポイント専用に変更）
- `unlocked_difficulties`: アンロック済み難易度（JSON形式、カテゴリ+タグ+難易度の組み合わせを保存）

アンロックのキー形式：`{category}_{difficulty}_{tags}`（例：`teams_normal_teams,japan,kashiwa`）

#### 1.2 新しいモデルの作成
`lib/models/promotion_exam.dart`を作成：
- 昇格試験の定義（必要ランク、必要ポイント、出題難易度、合格条件、対象カテゴリ、対象タグなど）

### 2. 経験値とポイントの分離

#### 2.1 定数の更新
`lib/utils/constants.dart`に以下を追加：
- `expPerCorrectAnswer`: 正解1問あたりのexp（10）
- `pointsPerCorrectAnswer`: 正解1問あたりのポイント（10）
- `expPerfectScoreBonus`: 全問正解ボーナスexp（50）
- `pointsPerfectScoreBonus`: 全問正解ボーナスポイント（50）
- `expRewardedAd`: 広告視聴報酬exp（100）
- `pointsRewardedAd`: 広告視聴報酬ポイント（100）
- `matchDayExpMultiplier`: MATCH DAYのexp倍率（5.0）
- `matchDayPointsMultiplier`: MATCH DAYのポイント倍率（5.0）

#### 2.2 ランクシステムの変更
`lib/models/user_rank.dart`を修正：
- `fromPoints`を`fromExp`に変更し、expベースでランクを計算
- ランクの閾値をexpベースに変更（例：Academy: 0-499 exp）

#### 2.3 プロバイダーの拡張
`lib/providers/user_data_provider.dart`を拡張：
- `totalExpProvider`: 累計expを管理
- `totalPointsProvider`: 累計ポイントを管理（既存を修正）
- `unlockedDifficultiesProvider`: アンロック済み難易度を管理（カテゴリ+タグ+難易度の組み合わせ）

### 3. 昇格試験システム

#### 3.1 昇格試験の定義
`lib/models/promotion_exam.dart`に以下を定義：
```dart
class PromotionExam {
  final String targetDifficulty; // アンロックする難易度
  final String sourceDifficulty; // 出題元の難易度
  final UserRank requiredRank; // 必要なランク
  final int requiredPoints; // 必要なポイント
  final int questionCount; // 問題数（20問）
  final int passScore; // 合格スコア（16問以上）
  final String category; // 対象カテゴリ
  final String tags; // 対象タグ（カンマ区切り、例："teams,japan,kashiwa"）
}
```

昇格試験の設定：
- EASY→NORMAL: ランクAcademy以上、ポイント1000
- NORMAL→HARD: ランクRookie以上、ポイント5000
- HARD→EXTREME: ランクRegular以上、ポイント10000

#### 3.2 アンロックキーの生成
`lib/utils/unlock_key_utils.dart`を作成：
- `generateUnlockKey(category, difficulty, tags)`: アンロックキーを生成
- `isUnlocked(category, difficulty, tags)`: アンロック状態をチェック
- タグの正規化（ソート、重複除去など）を実装

#### 3.3 昇格試験画面の作成
`lib/screens/promotion_exam_screen.dart`を作成：
- 昇格試験の説明と必要条件の表示
- 条件を満たしているかチェック
- 条件を満たしていない場合、不足している項目を表示
- 条件を満たしている場合、ポイントを消費して試験開始
- カテゴリとタグの選択機能（例：チームクイズで柏レイソルを選択）

#### 3.4 昇格試験のクイズ実装
`lib/screens/promotion_exam_quiz_screen.dart`を作成：
- 通常のクイズ画面と同様だが、20問出題
- 指定されたカテゴリ、タグ、出題元難易度から問題を取得
- 結果画面で16問以上正解なら合格、該当するカテゴリ+タグ+難易度をアンロック
- 不合格の場合はポイントは返却されない

### 4. 結果画面の改修

#### 4.1 広告視聴機能の追加
`lib/screens/result_screen.dart`を修正：
- 初期状態ではexpとポイントを加算しない（表示のみ）
- 「広告を見て報酬を獲得」ボタンを追加
- 広告視聴後にexpとポイントを加算
- 「トップに戻る」ボタンは広告視聴せずに戻る（報酬なし）

#### 4.2 expとポイントの表示
結果画面で以下を表示：
- 獲得exp（正解数 × 10 + 全問正解ボーナス50）
- 獲得ポイント（正解数 × 10 + 全問正解ボーナス50）
- 広告視聴による追加報酬（exp +100、ポイント +100）

### 5. MATCH DAY機能の実装

#### 5.1 週1回制限の実装
`lib/services/database_service.dart`に以下を追加：
- `getLastMatchDayPlayDate()`: 最後にMATCH DAYをプレイした日付を取得
- `recordMatchDayPlay()`: MATCH DAYのプレイを記録
- `canPlayMatchDay()`: 今週プレイ可能かチェック（週の開始日を基準に判定）
- `getMatchDayPlayCount()`: 今週のプレイ回数を取得（広告視聴含む）

#### 5.2 MATCH DAY画面の改修
`lib/screens/home_screen.dart`のMATCH DAYカードを修正：
- 週1回無料でプレイ可能（週の開始日は月曜日）
- 広告視聴で追加チャレンジ（最大3回まで、週単位でリセット）
- 今週のプレイ回数の表示
- expとポイントの5倍率表示
- 次回プレイ可能までの残り日数の表示

#### 5.3 MATCH DAYクイズの報酬計算
`lib/screens/quiz_screen.dart`を修正：
- MATCH DAYの場合、獲得expとポイントに倍率を適用

### 6. 難易度選択の制限

#### 6.1 設定画面の修正
`lib/screens/configuration_screen.dart`を修正：
- アンロックされていない難易度は選択不可（グレーアウト）
- アンロックされていない難易度には「昇格試験でアンロック」の表示
- カテゴリとタグの組み合わせごとにアンロック状態をチェック
- チームクイズの場合、選択された国や範囲に応じてタグを生成し、アンロック状態を判定

#### 6.2 ホーム画面への昇格試験ボタン
`lib/screens/home_screen.dart`に昇格試験セクションを追加：
- 現在のランクとポイントの表示
- アンロック可能な昇格試験の表示（カテゴリとタグごと）
- 昇格試験への導線

### 7. 広告実装（将来実装用の準備）

#### 7.1 広告サービスの準備
`lib/services/ad_service.dart`を作成（将来実装用）：
- Rewarded Adの表示機能
- 広告視聴完了時のコールバック

#### 7.2 広告統合ポイントの定義
結果画面とMATCH DAY画面で広告視聴の統合ポイントを定義

## データベースマイグレーション

既存の`total_points`データをexpとポイントに分割：
- 既存ユーザーの`total_points`をexpとポイントの両方に設定（互換性のため）

## バランス調整の提案

### expとポイントの獲得量
- 通常クイズ: 正解1問につきexp 10、ポイント 10
- 全問正解ボーナス: exp 50、ポイント 50
- 広告視聴報酬: exp 100、ポイント 100
- MATCH DAY: 上記の5倍（週1回の特別な報酬）

### 昇格試験の必要ポイント
- EASY→NORMAL: 1000ポイント（約1週間で解放可能）
- NORMAL→HARD: 5000ポイント（約1-2ヶ月）
- HARD→EXTREME: 10000ポイント（約2-3ヶ月）

### 広告視聴のインセンティブ
- 通常クイズ: 広告視聴でexp +100、ポイント +100（約10問分の報酬）
- MATCH DAY: 広告視聴で追加チャレンジ可能（報酬が5倍なので非常に効果的、週単位で最大3回まで）

## アンロック管理の詳細

### アンロックキーの形式
- 形式: `{category}_{difficulty}_{normalized_tags}`
- 例: `teams_normal_teams,japan,kashiwa`
- タグの正規化: カンマ区切りでソート、重複除去

### アンロック判定のロジック
1. ユーザーがクイズ設定画面でカテゴリ、難易度、タグ（国や範囲から生成）を選択
2. 選択された条件からアンロックキーを生成
3. アンロック済みかチェック
4. アンロックされていない場合、該当する昇格試験への導線を表示

### チームクイズのタグ生成例
- 国: 日本、範囲: J1全チーム → タグ: `teams,japan,j1`
- 国: 日本、範囲: 指定なし、チーム: 柏レイソル → タグ: `teams,japan,kashiwa`
- 国: 日本、範囲: 指定なし、チーム: マリノス → タグ: `teams,japan,marinos`

## 実装順序

1. データモデルの拡張（expとポイントの分離、アンロックキーの管理）
2. ランクシステムの変更（expベース）
3. アンロックキー生成ユーティリティの作成
4. 結果画面の改修（広告視聴機能の追加）
5. 昇格試験システムの実装（カテゴリ+タグ単位）
6. MATCH DAY機能の実装
7. 難易度選択の制限実装（カテゴリ+タグ単位のアンロック判定）
8. ホーム画面への昇格試験セクション追加
9. 広告実装（将来実装用の準備）
