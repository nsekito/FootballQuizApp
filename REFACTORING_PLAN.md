# リファクタリング計画

## 発見された問題点

### 1. 依存性注入の問題
- **問題**: `QuizHistoryService`が`DatabaseService.database`を直接アクセスしている
- **影響**: テストが困難、依存関係が不明確
- **改善**: コンストラクタで`DatabaseService`を注入

### 2. エラーハンドリングの重複
- **問題**: `history_screen.dart`と`statistics_screen.dart`で同じエラー表示コードが重複
- **影響**: 保守性の低下、一貫性の欠如
- **改善**: 共通のエラーウィジェットを作成

### 3. データベース初期化の重複コード
- **問題**: Web、デスクトップ、モバイルで似たような処理が重複
- **影響**: コードの肥大化、保守性の低下
- **改善**: プラットフォーム別の処理を統合

### 4. 統計情報計算の最適化
- **問題**: `getStatistics()`で複数のクエリを個別に実行
- **影響**: パフォーマンスの低下
- **改善**: 可能な限り1つのクエリに統合

### 5. 共通UIコンポーネントの不足
- **問題**: エラー表示、ローディング表示などが各画面で重複
- **影響**: コードの重複、一貫性の欠如
- **改善**: 共通ウィジェットを作成

### 6. 定数の整理
- **問題**: マジックナンバーや文字列リテラルが散在
- **影響**: 保守性の低下
- **改善**: 定数を`AppConstants`に集約

## リファクタリングの優先順位

1. **高優先度**: 依存性注入の改善、エラーハンドリングの統一
2. **中優先度**: 共通UIコンポーネントの作成、統計情報計算の最適化
3. **低優先度**: データベース初期化の統合、定数の整理

## 実装計画

### Phase 1: 依存性注入の改善
- `QuizHistoryService`に`DatabaseService`を注入
- プロバイダーで依存関係を管理

### Phase 2: 共通ウィジェットの作成
- `ErrorWidget` - エラー表示用
- `LoadingWidget` - ローディング表示用
- `EmptyStateWidget` - 空状態表示用

### Phase 3: エラーハンドリングの統一
- 各画面で共通ウィジェットを使用
- エラーメッセージの標準化

### Phase 4: 統計情報計算の最適化
- クエリの統合
- キャッシュの活用

### Phase 5: その他の改善
- データベース初期化の統合
- 定数の整理
